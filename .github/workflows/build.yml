name: Build artifacts

on:
  push:
    tags:
      - '*'

  workflow_dispatch:

jobs:
  # linux-x86_64:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v2
  #     - name: restore zig-cache
  #       id: cache-zig-restore
  #       uses: actions/cache/restore@v3
  #       with:
  #         path: |
  #           zig-cache
  #         key: ${{ runner.os }}-zig-cache-${{ github.run_id }}
  #         restore-keys: |
  #           ${{ runner.os }}-zig-cache
  #     - name: build seamstress
  #       run: |
  #         bash ci/ubuntu.sh
  #     - name: save zig-cache
  #       id: cache-zig-save
  #       uses: actions/cache/save@v3
  #       with:
  #         path: |
  #           zig-cache
  #         key: ${{ runner.os }}-zig-cache-${{ github.run_id }}
  #     - name: zip artifact
  #       run: |
  #         cd zig-out/ && tar -czvf ../seamstress-linux-x86_64-${{ github.ref_name }}.tar.gz .
  #     - uses: actions/upload-artifact@v2
  #       with:
  #         name: linux-x86_64-${{ github.ref_name }}
  #         path: |
  #           ./*.tar.gz
  # macos-x86_64:
  #   runs-on: macos-latest
  #   steps:
  #     - uses: actions/checkout@v2
  #     - uses: Homebrew/actions/setup-homebrew@master
  #     - name: restore zig-cache
  #       id: cache-zig-restore
  #       uses: actions/cache/restore@v3
  #       with:
  #         path: |
  #           zig-cache
  #         key: ${{ runner.os }}-zig-cache-${{ github.run_id }}
  #         restore-keys: |
  #           ${{ runner.os }}-zig-cache
  #     - name: build seamstress
  #       run: |
  #         bash ci/macos-11.sh
  #     - name: save zig-cache
  #       id: cache-zig-save
  #       uses: actions/cache/save@v3
  #       with:
  #         path: |
  #           zig-cache
  #         key: ${{ runner.os }}-zig-cache-${{ github.run_id }}
  #     - name: zip artifact
  #       run: |
  #         cd zig-out/ && zip -r9 ../seamstress-macos-x86_64-${{ github.ref_name }}.zip .
  #     - uses: actions/upload-artifact@v2
  #       with:
  #         name: macos-x86_64-${{ github.ref_name }}
  #         path: |
  #           ./*.zip

  windows:
    runs-on: windows-latest
    strategy:
        matrix:
          include:
            - { sys: mingw64, env: x86_64 }
    defaults:
      run:
        # shell: C:\msys64\msys2.exe {0}
        shell: bash
    steps:
      - name: Put MSYS2_MinGW64 on PATH
        run: |
          ## - powershell
          # echo "C:\msys64\usr\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          # echo "C:\msys64\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          ## - bash w/ `msys2/setup-msys2@v2`
          #run: echo "D:/a/_temp/msys64/mingw64/bin" >> $GITHUB_PATH
          ## - bash w/ default msys2 env
          echo "C:/msys64/usr/bin" >> $GITHUB_PATH
          echo "C:/msys64/mingw64/bin" >> $GITHUB_PATH
      ## NB: disabling as closes the TTY when upgrading MinTTY...
      ##     only happens when using bash and not powershell
      #- name: update msys2 packages
      #  run: |
      #    pacman --noconfirm -Suy
      - name: install build deps
        run: |
          pacman --noconfirm -S wget
          pacman --noconfirm -S unzip
          pacman --noconfirm -S mingw-w64-${{matrix.env}}-pkg-config
          pacman --noconfirm -S mingw-w64-${{matrix.env}}-dlfcn
          pacman --noconfirm -S mingw-w64-${{matrix.env}}-liblo
          pacman --noconfirm -S mingw-w64-${{matrix.env}}-rtmidi
          pacman --noconfirm -S mingw-w64-${{matrix.env}}-SDL2
          pacman --noconfirm -S mingw-w64-${{matrix.env}}-SDL2_ttf
          pacman --noconfirm -S mingw-w64-${{matrix.env}}-SDL2_image
          pacman --noconfirm -S mingw-w64-${{matrix.env}}-readline
          pacman --noconfirm -S mingw-w64-${{matrix.env}}-winpthreads-git
   
      # - uses: msys2/setup-msys2@v2
      #   with:
      #     update: true
      #     msystem: ${{matrix.sys}}
      #     install: >-
      #       wget
      #       unzip
      #       mingw-w64-${{matrix.env}}-pkg-config
      #       mingw-w64-${{matrix.env}}-dlfcn
      #       mingw-w64-${{matrix.env}}-liblo
      #       mingw-w64-${{matrix.env}}-rtmidi
      #       mingw-w64-${{matrix.env}}-SDL2
      #       mingw-w64-${{matrix.env}}-SDL2_ttf
      #       mingw-w64-${{matrix.env}}-SDL2_image
      #       mingw-w64-${{matrix.env}}-readline
      #       mingw-w64-${{matrix.env}}-winpthreads-git
      #   # MKlink /D C:\msys64 D:\a\_temp\msys64

      # - uses: actions/checkout@v3
      # # - name: download zig
      # #   run: |
      # #     wget https://ziglang.org/download/0.11.0/zig-windows-${{matrix.env}}-0.11.0.zip
      # - name: build seamstress
      #   run: |
      #     bash ci/windows.sh

  # release:
  #   runs-on: ubuntu-latest
  #   needs: [macos-x86_64,linux-x86_64]
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: actions/download-artifact@v3
  #     - uses: softprops/action-gh-release@v1
  #       if: startsWith(github.ref, 'refs/tags/')
  #       with:
  #         draft: true
  #         files: |
  #           ./macos-x86_64-${{ github.ref_name }}/*.zip
  #           ./linux-x86_64-${{ github.ref_name }}/*.tar.gz
